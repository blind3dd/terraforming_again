# Unified Environment Structure

## ğŸ¯ Complete Environment Flow

```
Developer Commits
      â†“
GitHub Actions (CI/CD)
  â”œâ”€â”€ Uses GitHub Environment: dev/test/prod
  â”œâ”€â”€ Assumes IAM Role: iacrole
  â””â”€â”€ Runs in order:
      â†“
1. Terraform Apply
   â”œâ”€â”€ Workspace: dev/test/prod
   â”œâ”€â”€ Creates: VPC, EC2, RDS
   â”œâ”€â”€ Tags: Environment=dev/test/prod
   â””â”€â”€ Outputs to:
       â”œâ”€â”€ infrastructure/ansible/inventory/{env}/hosts.yml
       â””â”€â”€ infrastructure/ansible/group_vars/{env}.yml
      â†“
2. Ansible Configure
   â”œâ”€â”€ Reads: inventory/{env}/hosts.yml
   â”œâ”€â”€ Uses: group_vars/{env}.yml
   â”œâ”€â”€ Deploys: ArgoCD Applications
   â””â”€â”€ Creates: K8s ConfigMaps with Terraform outputs
      â†“
3. ArgoCD Syncs
   â”œâ”€â”€ Watches: infrastructure/kubernetes/overlays/{env}/
   â”œâ”€â”€ Renders: Kustomize/Helm with env-specific values
   â””â”€â”€ Deploys: To namespace {env}
      â†“
4. Application Runs
   â””â”€â”€ In Kubernetes namespace: dev/test/prod
```

---

## ğŸ“ Complete Directory Structure

```
terraforming_again/
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ terraform/
â”‚   â”‚   â”œâ”€â”€ modules/              # Reusable modules
â”‚   â”‚   â”‚   â”œâ”€â”€ networking/
â”‚   â”‚   â”‚   â”œâ”€â”€ compute/
â”‚   â”‚   â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”‚   â””â”€â”€ tailscale/
â”‚   â”‚   â””â”€â”€ environments/
â”‚   â”‚       â”œâ”€â”€ dev/
â”‚   â”‚       â”‚   â”œâ”€â”€ main.tf       # Calls modules
â”‚   â”‚       â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚       â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â”‚       â”‚   â”œâ”€â”€ outputs.tf    # â†’ Generates Ansible files
â”‚   â”‚       â”‚   â””â”€â”€ templates/
â”‚   â”‚       â”‚       â””â”€â”€ ansible-inventory.tpl
â”‚   â”‚       â”œâ”€â”€ test/             # Same structure as dev
â”‚   â”‚       â”œâ”€â”€ prod/             # Same structure as dev
â”‚   â”‚       â””â”€â”€ shared/           # Shared variables
â”‚   â”‚
â”‚   â”œâ”€â”€ ansible/
â”‚   â”‚   â”œâ”€â”€ inventory/
â”‚   â”‚   â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ hosts.yml    # â† Generated by Terraform
â”‚   â”‚   â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ hosts.yml    # â† Generated by Terraform
â”‚   â”‚   â”‚   â””â”€â”€ prod/
â”‚   â”‚   â”‚       â””â”€â”€ hosts.yml    # â† Generated by Terraform
â”‚   â”‚   â”œâ”€â”€ group_vars/
â”‚   â”‚   â”‚   â”œâ”€â”€ all.yml          # Common to all environments
â”‚   â”‚   â”‚   â”œâ”€â”€ dev.yml          # â† Generated by Terraform
â”‚   â”‚   â”‚   â”œâ”€â”€ test.yml         # â† Generated by Terraform
â”‚   â”‚   â”‚   â””â”€â”€ prod.yml         # â† Generated by Terraform
â”‚   â”‚   â”œâ”€â”€ playbooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ deploy-k8s-apps.yml    # â†’ Deploys ArgoCD apps
â”‚   â”‚   â”‚   â””â”€â”€ site.yml
â”‚   â”‚   â””â”€â”€ roles/
â”‚   â”‚
â”‚   â””â”€â”€ kubernetes/
â”‚       â”œâ”€â”€ base/                 # Base Kubernetes manifests
â”‚       â”‚   â”œâ”€â”€ deployment.yaml
â”‚       â”‚   â”œâ”€â”€ service.yaml
â”‚       â”‚   â”œâ”€â”€ configmap.yaml
â”‚       â”‚   â””â”€â”€ kustomization.yaml
â”‚       â””â”€â”€ overlays/
â”‚           â”œâ”€â”€ dev/              # Dev-specific patches
â”‚           â”‚   â”œâ”€â”€ kustomization.yaml    # â† ArgoCD watches
â”‚           â”‚   â”œâ”€â”€ replicas-patch.yaml   # 1 replica
â”‚           â”‚   â””â”€â”€ service-patch.yaml    # NodePort
â”‚           â”œâ”€â”€ test/             # Test-specific patches
â”‚           â”‚   â”œâ”€â”€ kustomization.yaml    # â† ArgoCD watches
â”‚           â”‚   â”œâ”€â”€ replicas-patch.yaml   # 2 replicas
â”‚           â”‚   â”œâ”€â”€ service-patch.yaml    # LoadBalancer
â”‚           â”‚   â””â”€â”€ resources-patch.yaml  # Medium resources
â”‚           â””â”€â”€ prod/             # Prod-specific patches
â”‚               â”œâ”€â”€ kustomization.yaml    # â† ArgoCD watches
â”‚               â”œâ”€â”€ replicas-patch.yaml   # 3 replicas
â”‚               â”œâ”€â”€ service-patch.yaml    # LoadBalancer + annotations
â”‚               â”œâ”€â”€ resources-patch.yaml  # Large resources
â”‚               â””â”€â”€ hpa.yaml              # Autoscaling
â”‚
â”œâ”€â”€ platform/
â”‚   â””â”€â”€ argocd/
â”‚       â””â”€â”€ applications/
â”‚           â”œâ”€â”€ dev/
â”‚           â”‚   â””â”€â”€ go-mysql-api.yaml     # â† Deployed by Ansible
â”‚           â”œâ”€â”€ test/
â”‚           â”‚   â””â”€â”€ go-mysql-api.yaml     # â† Deployed by Ansible
â”‚           â””â”€â”€ prod/
â”‚               â””â”€â”€ go-mysql-api.yaml     # â† Deployed by Ansible
â”‚
â””â”€â”€ .github/
    â””â”€â”€ workflows/
        â””â”€â”€ ci-cd-pipeline.yml    # Uses GitHub Env: dev/test/prod
```

---

## ğŸ”„ Data Flow by Layer

### **Layer 1: Terraform (Infrastructure as Code)**

**Input:** `terraform.tfvars`
```hcl
environment = "dev"
instance_type = "t3.micro"
enable_nat_gateway = false
```

**Process:**
```bash
cd infrastructure/terraform/environments/dev
terraform workspace select dev
terraform apply
```

**Output:**
```yaml
# infrastructure/ansible/inventory/dev/hosts.yml
all:
  vars:
    environment: dev
    vpc_id: vpc-12345
    rds_endpoint: mydb.c9ac.us-east-1.rds.amazonaws.com
  children:
    dev:
      hosts:
        ec2-dev-0:
          ansible_host: 172.16.1.10
```

---

### **Layer 2: Ansible (Configuration as Code)**

**Input:** 
- `inventory/dev/hosts.yml` (from Terraform)
- `group_vars/dev.yml` (from Terraform)

**Process:**
```bash
ansible-playbook \
  -i infrastructure/ansible/inventory/dev/hosts.yml \
  -e "environment=dev" \
  infrastructure/ansible/playbooks/deploy-k8s-apps.yml
```

**Output:**
- ArgoCD Application deployed to K8s
- ConfigMap with Terraform outputs
- Secrets for database credentials

---

### **Layer 3: GitHub Actions (CI/CD Orchestration)**

**Input:** Git push to `working_branch`

**Process:**
```yaml
jobs:
  deploy-dev:
    environment: dev  # GitHub Environment
    steps:
      - terraform apply (dev)
      - ansible-playbook (dev inventory)
      - argocd app sync (dev app)
```

**Output:** Complete environment deployed

---

### **Layer 4: ArgoCD (GitOps Deployment)**

**Input:** 
- Application: `platform/argocd/applications/dev/go-mysql-api.yaml`
- Source: `infrastructure/kubernetes/overlays/dev/`

**Process:**
```yaml
ArgoCD watches: overlays/dev/
Detects changes â†’ Syncs automatically (dev/test)
Requires manual sync (prod)
```

**Output:** Kubernetes resources in namespace `dev`

---

### **Layer 5: Kustomize (Manifest Rendering)**

**Input:**
- Base: `infrastructure/kubernetes/base/`
- Overlay: `infrastructure/kubernetes/overlays/dev/`

**Process:**
```bash
kustomize build infrastructure/kubernetes/overlays/dev/
```

**Output:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: go-mysql-api
  namespace: dev
  labels:
    environment: dev
spec:
  replicas: 1  # From dev overlay
  template:
    spec:
      containers:
      - name: api
        env:
        - name: DB_HOST
          value: "mydb.c9ac.us-east-1.rds.amazonaws.com"  # From Terraform
        resources:
          requests:
            cpu: 100m   # Dev resources
            memory: 128Mi
```

---

## ğŸ” IAM Role Strategy (Your Current Setup)

### **Single Role for Dev & Test:**

```
IAM Role: arn:aws:iam::690248313240:role/iacrole

Used by:
  - GitHub Actions (via OIDC)
  - Local dev (via AssumeRole with MFA)
  - Terraform (via AWS_PROFILE=dev)

Separation via:
  âœ… Terraform workspaces (dev, test, prod)
  âœ… Resource tags (Environment=dev/test/prod)
  âœ… GitHub Environment protection rules
  âœ… State file isolation
```

**GitHub Environments:**
- **dev**: Secret `AWS_ROLE_TO_ASSUME` = `...iacrole`, no protection
- **test**: Secret `AWS_ROLE_TO_ASSUME` = `...iacrole`, wait timer
- **prod**: Secret `AWS_ROLE_TO_ASSUME` = `...iacrole-prod` (different account), requires approval

---

## ğŸ“Š Environment Comparison

| Feature | Dev | Test | Prod |
|---------|-----|------|------|
| **AWS Account** | 690248313240 | 690248313240 | 987654321098 |
| **IAM Role** | iacrole | iacrole | iacrole-prod |
| **GitHub Env** | dev | test | prod |
| **Terraform Workspace** | dev | test | prod |
| **K8s Namespace** | dev | test | prod |
| **Replicas** | 1 | 2 | 3+ (HPA) |
| **Instance Type** | t3.micro | t3.small | t3.small |
| **NAT Gateway** | No (Tailscale) | Yes | Yes (Multi-AZ) |
| **RDS** | db.t3.micro | db.t3.small | db.t3.small (Multi-AZ) |
| **Service Type** | NodePort | LoadBalancer | LoadBalancer |
| **Auto-scaling** | No | No | Yes (HPA) |
| **ArgoCD Sync** | Auto | Auto | Manual |
| **Branch Restriction** | Any | main, working_branch | main only |
| **Approval Required** | No | No | Yes |
| **Monthly Cost** | ~$40 | ~$70 | ~$140 |

---

## ğŸš€ Usage Examples

### **Deploy Dev Environment:**

```bash
# 1. Update Terraform config
vim infrastructure/terraform/environments/dev/terraform.tfvars

# 2. Apply Terraform
cd infrastructure/terraform/environments/dev
terraform workspace select dev
terraform apply  # Generates Ansible inventory

# 3. Configure with Ansible
cd ../../../../
ansible-playbook \
  -i infrastructure/ansible/inventory/dev/hosts.yml \
  -e "environment=dev" \
  infrastructure/ansible/playbooks/deploy-k8s-apps.yml

# 4. ArgoCD auto-syncs (or manual sync)
kubectl apply -f platform/argocd/applications/dev/go-mysql-api.yaml
```

### **Or Use GitHub Actions:**

```bash
# Push to trigger workflow
git add infrastructure/terraform/environments/dev/
git commit -m "update: dev environment config"
git push origin working_branch

# GitHub Actions will:
# 1. Assume iacrole via OIDC
# 2. Run terraform apply
# 3. Generate Ansible inventory
# 4. Run Ansible playbook
# 5. Trigger ArgoCD sync
```

---

## âœ… Benefits of This Structure

1. **Single Source of Truth**: All config in Git
2. **Environment Consistency**: Same structure across dev/test/prod
3. **Automatic Propagation**: Terraform â†’ Ansible â†’ GitHub â†’ ArgoCD â†’ K8s
4. **Cost Optimized**: Different resources per environment
5. **GitOps Ready**: ArgoCD watches for changes
6. **Secure**: IAM role per environment (via GitHub Environments)
7. **Auditable**: All changes tracked in Git

---

**Your infrastructure is now fully unified across all layers!** ğŸ‰


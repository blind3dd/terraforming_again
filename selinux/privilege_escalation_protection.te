# SELinux Policy for Privilege Escalation Protection
# This policy prevents unauthorized privilege escalation attempts

policy_module(privilege_escalation_protection, 1.0.0)

require {
    type user_t;
    type admin_t;
    type sudo_t;
    type su_t;
    type passwd_t;
    type shadow_t;
    type group_t;
    type gshadow_t;
    type systemd_t;
    type dbusd_t;
    type sshd_t;
    type local_login_t;
    type unconfined_t;
    type bin_t;
    type sbin_t;
    type usr_t;
    type var_t;
    type tmp_t;
    type home_root_t;
    class file { read write create getattr execute execute_no_trans setattr };
    class process { transition signal setexec setpgid setsched setrlimit siginh sigkill sigstop };
    class capability { sys_admin sys_module dac_override dac_read_search fowner fsetid kill setuid setgid setpcap linux_immutable net_bind_service net_broadcast net_admin net_raw ipc_lock ipc_owner sys_rawio sys_chroot sys_ptrace sys_pacct sys_admin sys_boot sys_nice sys_resource sys_time sys_tty_config mknod lease audit_write audit_control setfcap mac_override mac_admin syslog wake_alarm block_suspend audit_read };
    class unix_stream_socket { connectto create };
    class dbus send_msg;
    class passwd { passwd };
    class shadow { passwd };
    class group { passwd };
    class gshadow { passwd };
}

# Prevent privilege escalation through sudo
neverallow user_t sudo_t:process transition;
neverallow user_t sudo_t:unix_stream_socket connectto;

# Prevent privilege escalation through su
neverallow user_t su_t:process transition;
neverallow user_t su_t:unix_stream_socket connectto;

# Prevent direct admin access
neverallow user_t admin_t:process transition;
neverallow user_t admin_t:unix_stream_socket connectto;

# Prevent capability escalation
neverallow user_t self:capability { sys_admin sys_module dac_override dac_read_search fowner fsetid kill setuid setgid setpcap linux_immutable net_bind_service net_broadcast net_admin net_raw ipc_lock ipc_owner sys_rawio sys_chroot sys_ptrace sys_pacct sys_admin sys_boot sys_nice sys_resource sys_time sys_tty_config mknod lease audit_write audit_control setfcap mac_override mac_admin syslog wake_alarm block_suspend audit_read };

# Prevent password file manipulation
neverallow user_t passwd_t:file { write create };
neverallow user_t shadow_t:file { write create };
neverallow user_t group_t:file { write create };
neverallow user_t gshadow_t:file { write create };

# Prevent password change operations
neverallow user_t passwd_t:passwd passwd;
neverallow user_t shadow_t:shadow passwd;
neverallow user_t group_t:group passwd;
neverallow user_t gshadow_t:gshadow passwd;

# Prevent systemd service manipulation
neverallow user_t systemd_t:process signal;
neverallow user_t systemd_t:unix_stream_socket connectto;

# Prevent D-Bus privilege escalation
neverallow user_t dbusd_t:dbus send_msg;
neverallow user_t dbusd_t:unix_stream_socket connectto;

# Prevent SSH privilege escalation
neverallow user_t sshd_t:process signal;
neverallow user_t sshd_t:unix_stream_socket connectto;

# Prevent local login privilege escalation
neverallow user_t local_login_t:process transition;
neverallow user_t local_login_t:unix_stream_socket connectto;

# Allow legitimate user operations
allow user_t self:process { signal };
allow user_t self:file { read write create getattr };

# Allow reading system files for normal operations
allow user_t passwd_t:file { read getattr };
allow user_t shadow_t:file { read getattr };
allow user_t group_t:file { read getattr };
allow user_t gshadow_t:file { read getattr };

# Allow legitimate D-Bus communication (read-only)
allow user_t dbusd_t:unix_stream_socket connectto;

# Prevent unconfined access (if unconfined_t exists)
neverallow user_t unconfined_t:process transition;
neverallow user_t unconfined_t:unix_stream_socket connectto;

# ===== SUID PROTECTION =====
# Prevent SUID/SGID file creation by users
neverallow user_t self:file { setattr };
neverallow user_t bin_t:file { write create setattr };
neverallow user_t sbin_t:file { write create setattr };
neverallow user_t usr_t:file { write create setattr };

# Prevent execution of SUID/SGID binaries from user directories
neverallow user_t tmp_t:file execute;
neverallow user_t var_t:file execute;
neverallow user_t home_root_t:file execute;

# Prevent SUID/SGID execution with dangerous capabilities
neverallow user_t self:capability { setuid setgid fsetid };
neverallow user_t self:process { setexec };

# Prevent creation of SUID/SGID files in writable locations
neverallow user_t tmp_t:file { create write setattr };
neverallow user_t var_t:file { create write setattr };
neverallow user_t home_root_t:file { create write setattr };

# Prevent modification of existing SUID/SGID files
neverallow user_t bin_t:file { write setattr };
neverallow user_t sbin_t:file { write setattr };
neverallow user_t usr_t:file { write setattr };

# Prevent process execution with SUID/SGID privileges
neverallow user_t self:process { setexec setpgid setsched setrlimit };

# Prevent signal manipulation for privilege escalation
neverallow user_t self:process { siginh sigkill sigstop };

# Prevent execution of binaries that could lead to privilege escalation
neverallow user_t bin_t:file execute_no_trans;
neverallow user_t sbin_t:file execute_no_trans;
neverallow user_t usr_t:file execute_no_trans;

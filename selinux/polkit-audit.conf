# Audit Rules for Polkit (PolicyKit) Security Events
# This file defines what Polkit events to audit

# Configure audit log file locations
-w /var/log/audit.log -p wa -k audit_log
-w /var/log/secure -p wa -k secure_log

# ===== POLKIT DAEMON EVENTS =====
# Polkit daemon configuration access
-a always,exit -F arch=b64 -S openat -F path=/etc/polkit-1 -F key=polkit_config
-a always,exit -F arch=b64 -S openat -F path=/usr/share/polkit-1 -F key=polkit_rules

# Polkit daemon log access
-a always,exit -F arch=b64 -S openat -F path=/var/log/polkit -F key=polkit_log
-a always,exit -F arch=b64 -S openat -F path=/var/log/secure -F key=polkit_secure_log

# ===== PRIVILEGE ESCALATION REQUESTS =====
# Polkit privilege requests (via D-Bus)
-a always,exit -F arch=b64 -S connect -F key=polkit_dbus_connect
-a always,exit -F arch=b64 -S sendmsg -F key=polkit_dbus_send
-a always,exit -F arch=b64 -S recvmsg -F key=polkit_dbus_recv

# ===== SYSTEM PRIVILEGE ACTIONS =====
# Network configuration changes
-a always,exit -F arch=b64 -S openat -F path=/etc/network -F key=polkit_network_config
-a always,exit -F arch=b64 -S openat -F path=/etc/systemd/network -F key=polkit_systemd_network

# Service management
-a always,exit -F arch=b64 -S openat -F path=/etc/systemd/system -F key=polkit_systemd_services
-a always,exit -F arch=b64 -S openat -F path=/usr/lib/systemd/system -F key=polkit_systemd_lib

# User management
-a always,exit -F arch=b64 -S openat -F path=/etc/passwd -F key=polkit_user_management
-a always,exit -F arch=b64 -S openat -F path=/etc/shadow -F key=polkit_shadow_access
-a always,exit -F arch=b64 -S openat -F path=/etc/group -F key=polkit_group_management

# System configuration
-a always,exit -F arch=b64 -S openat -F path=/etc/sudoers -F key=polkit_sudoers
-a always,exit -F arch=b64 -S openat -F path=/etc/sudoers.d -F key=polkit_sudoers_d

# ===== DANGEROUS OPERATIONS =====
# File system operations
-a always,exit -F arch=b64 -S mount -F key=polkit_mount
-a always,exit -F arch=b64 -S umount -F key=polkit_umount
-a always,exit -F arch=b64 -S chroot -F key=polkit_chroot

# Process operations
-a always,exit -F arch=b64 -S kill -F key=polkit_kill
-a always,exit -F arch=b64 -S ptrace -F key=polkit_ptrace

# ===== POLKIT RULE CHANGES =====
# Watch for changes to Polkit rules
-w /etc/polkit-1/rules.d/ -p wa -k polkit_rules_changes
-w /usr/share/polkit-1/rules.d/ -p wa -k polkit_rules_changes

# Watch for changes to Polkit configuration
-w /etc/polkit-1/localauthority/ -p wa -k polkit_config_changes
-w /usr/share/polkit-1/actions/ -p wa -k polkit_actions_changes

# ===== AUTHENTICATION EVENTS =====
# Polkit authentication attempts
-a always,exit -F arch=b64 -S openat -F path=/etc/pam.d -F key=polkit_pam_auth
-a always,exit -F arch=b64 -S openat -F path=/etc/security -F key=polkit_security_config

# ===== SYSTEM INTEGRATION =====
# Integration with systemd
-a always,exit -F arch=b64 -S openat -F path=/run/systemd -F key=polkit_systemd_integration
-a always,exit -F arch=b64 -S openat -F path=/var/lib/systemd -F key=polkit_systemd_state

# Integration with D-Bus
-a always,exit -F arch=b64 -S openat -F path=/var/run/dbus -F key=polkit_dbus_integration
-a always,exit -F arch=b64 -S openat -F path=/etc/dbus-1 -F key=polkit_dbus_config

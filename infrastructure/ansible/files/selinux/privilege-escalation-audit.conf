# Audit Rules for Privilege Escalation Detection
# This file defines what privilege escalation events to audit

# Configure audit log file locations
-w /var/log/audit.log -p wa -k audit_log
-w /var/log/secure -p wa -k secure_log

# ===== SUID/SGID PROTECTION AUDIT =====
# SUID/SGID file creation/modification
-a always,exit -F arch=b64 -S chmod -F perm=u+s -F key=suid_file_creation
-a always,exit -F arch=b32 -S chmod -F perm=u+s -F key=suid_file_creation
-a always,exit -F arch=b64 -S chmod -F perm=g+s -F key=sgid_file_creation
-a always,exit -F arch=b32 -S chmod -F perm=g+s -F key=sgid_file_creation
-a always,exit -F arch=b64 -S fchmod -F perm=u+s -F key=suid_file_creation
-a always,exit -F arch=b32 -S fchmod -F perm=u+s -F key=suid_file_creation
-a always,exit -F arch=b64 -S fchmod -F perm=g+s -F key=sgid_file_creation
-a always,exit -F arch=b32 -S fchmod -F perm=g+s -F key=sgid_file_creation
-a always,exit -F arch=b64 -S fchmodat -F perm=u+s -F key=suid_file_creation
-a always,exit -F arch=b32 -S fchmodat -F perm=u+s -F key=suid_file_creation
-a always,exit -F arch=b64 -S fchmodat -F perm=g+s -F key=sgid_file_creation
-a always,exit -F arch=b32 -S fchmodat -F perm=g+s -F key=sgid_file_creation

# SUID/SGID execution attempts
-a always,exit -F arch=b64 -S execve -F perm=x -F auid>=1000 -F auid!=unset -F success=0 -F euid=0 -F key=suid_execution
-a always,exit -F arch=b32 -S execve -F perm=x -F auid>=1000 -F auid!=unset -F success=0 -F euid=0 -F key=suid_execution
-a always,exit -F arch=b64 -S execve -F perm=x -F auid>=1000 -F auid!=unset -F success=0 -F egid=0 -F key=sgid_execution
-a always,exit -F arch=b32 -S execve -F perm=x -F auid>=1000 -F auid!=unset -F success=0 -F egid=0 -F key=sgid_execution

# File permission changes that could enable SUID/SGID
-a always,exit -F arch=b64 -S chmod -F perm=4777 -F key=dangerous_permissions
-a always,exit -F arch=b32 -S chmod -F perm=4777 -F key=dangerous_permissions
-a always,exit -F arch=b64 -S chmod -F perm=2777 -F key=dangerous_permissions
-a always,exit -F arch=b32 -S chmod -F perm=2777 -F key=dangerous_permissions
-a always,exit -F arch=b64 -S fchmod -F perm=4777 -F key=dangerous_permissions
-a always,exit -F arch=b32 -S fchmod -F perm=4777 -F key=dangerous_permissions
-a always,exit -F arch=b64 -S fchmod -F perm=2777 -F key=dangerous_permissions
-a always,exit -F arch=b32 -S fchmod -F perm=2777 -F key=dangerous_permissions

# Sudo privilege escalation attempts
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/sudo -F key=privilege_escalation
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/sudoedit -F key=privilege_escalation
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/visudo -F key=privilege_escalation

# Su privilege escalation attempts
-a always,exit -F arch=b64 -S execve -F path=/bin/su -F key=privilege_escalation
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/su -F key=privilege_escalation

# Password change attempts
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/passwd -F key=password_change
-a always,exit -F arch=b64 -S execve -F path=/bin/passwd -F key=password_change
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/passwd -F key=password_change

# User management attempts
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/useradd -F key=user_management
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/userdel -F key=user_management
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/usermod -F key=user_management
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/groupadd -F key=user_management
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/groupdel -F key=user_management
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/groupmod -F key=user_management

# System service manipulation
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/systemctl -F key=systemctl_usage
-a always,exit -F arch=b64 -S execve -F path=/bin/systemctl -F key=systemctl_usage
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/service -F key=service_usage

# File permission changes
-a always,exit -F arch=b64 -S execve -F path=/bin/chmod -F key=file_permissions
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/chmod -F key=file_permissions
-a always,exit -F arch=b64 -S execve -F path=/bin/chown -F key=file_permissions
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/chown -F key=file_permissions
-a always,exit -F arch=b64 -S execve -F path=/bin/chgrp -F key=file_permissions
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/chgrp -F key=file_permissions

# Setuid/setgid execution
-a always,exit -F arch=b64 -S execve -F auid>=1000 -F key=setuid_execution

# Capability changes
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/setcap -F key=capability_change
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/getcap -F key=capability_change

# Kernel module loading
-a always,exit -F arch=b64 -S execve -F path=/sbin/insmod -F key=kernel_module
-a always,exit -F arch=b64 -S execve -F path=/sbin/rmmod -F key=kernel_module
-a always,exit -F arch=b64 -S execve -F path=/sbin/modprobe -F key=kernel_module

# Network configuration changes
-a always,exit -F arch=b64 -S execve -F path=/sbin/ifconfig -F key=network_config
-a always,exit -F arch=b64 -S execve -F path=/sbin/ip -F key=network_config
-a always,exit -F arch=b64 -S execve -F path=/sbin/route -F key=network_config
-a always,exit -F arch=b64 -S execve -F path=/sbin/iptables -F key=network_config

# File system operations
-a always,exit -F arch=b64 -S execve -F path=/bin/mount -F key=filesystem_ops
-a always,exit -F arch=b64 -S execve -F path=/bin/umount -F key=filesystem_ops
-a always,exit -F arch=b64 -S execve -F path=/sbin/mount -F key=filesystem_ops
-a always,exit -F arch=b64 -S execve -F path=/sbin/umount -F key=filesystem_ops

# Process manipulation
-a always,exit -F arch=b64 -S execve -F path=/bin/kill -F key=process_manipulation
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/kill -F key=process_manipulation
-a always,exit -F arch=b64 -S execve -F path=/bin/killall -F key=process_manipulation
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/killall -F key=process_manipulation

# Cron job manipulation
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/crontab -F key=cron_manipulation
-a always,exit -F arch=b64 -S execve -F path=/bin/crontab -F key=cron_manipulation

# Shell access with elevated privileges
-a always,exit -F arch=b64 -S execve -F path=/bin/bash -F auid=0 -F key=root_shell
-a always,exit -F arch=b64 -S execve -F path=/bin/sh -F auid=0 -F key=root_shell
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/bash -F auid=0 -F key=root_shell

# SELinux Policy for Polkit (PolicyKit) Security
# This policy ensures Polkit daemon security and proper privilege control

module polkit_security 1.0.0;

require {
    type polkitd_t;
    type polkitd_exec_t;
    type polkitd_config_t;
    type polkitd_log_t;
    type systemd_t;
    type unconfined_t;
    type staff_t;
    type user_t;
    type admin_t;
    type auditd_t;
    type auditd_log_t;
    class file { read write create getattr append };
    class process { signal transition };
    class service { start stop status };
    class dbus { send_msg receive_msg };
    class unix_stream_socket { connectto };
}

# Allow Polkit daemon to access its configuration and logs
allow polkitd_t polkitd_config_t:file { read getattr };
allow polkitd_t polkitd_log_t:file { write append create getattr };

# Allow systemd to manage Polkit daemon
allow systemd_t polkitd_t:service { start stop status };
allow systemd_t polkitd_t:process signal;

# Allow Polkit to communicate via D-Bus (essential for privilege requests)
allow polkitd_t self:unix_stream_socket connectto;
allow polkitd_t self:dbus { send_msg receive_msg };

# Allow Polkit to write to audit logs for privilege escalation events
allow polkitd_t auditd_log_t:file { write append };

# Allow Polkit to read system configuration files
allow polkitd_t self:file { read getattr };

# Prevent unauthorized access to Polkit configuration
neverallow user_t polkitd_config_t:file { write create };
neverallow staff_t polkitd_config_t:file { write create };

# Only allow root and wheel group to read Polkit logs
allow unconfined_t polkitd_log_t:file { read getattr };
allow staff_t polkitd_log_t:file { read getattr };

# Allow root and sudoers to check Polkit service status
allow unconfined_t polkitd_t:service status;
allow staff_t polkitd_t:service status;

# Prevent cross-service transitions to Polkit (security isolation)
neverallow sshd_t polkitd_t:process transition;
neverallow sssd_t polkitd_t:process transition;
neverallow pam_t polkitd_t:process transition;

# Allow Polkit to access minimal system resources
allow polkitd_t self:process signal;

# Note: polkitd_t runs with minimal privileges and uses D-Bus for communication
